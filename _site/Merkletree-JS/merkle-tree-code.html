<!DOCTYPE html> <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="stylesheet" type="text/css" href="/assets/css/materialize.css"> <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"> <link rel="stylesheet" href="https://cdn.rawgit.com/konpa/devicon/df6431e323547add1b4cf45992913f15286456d3/devicon.min.css"> <title>Salma Sultana</title> </head> <body> <h1 id="merkle-tree-code-in-js">Merkle Tree Code in JS</h1> <h2 id="variables">Variables</h2> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">sha256</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"js-sha256"</span><span class="p">).</span><span class="nx">sha256</span>

<span class="kd">const</span> <span class="nx">txs</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s2">"tx1"</span><span class="p">,</span>
  <span class="s2">"tx2"</span><span class="p">,</span>
  <span class="s2">"tx3"</span><span class="p">,</span>
  <span class="s2">"tx4"</span><span class="p">,</span>
  <span class="s2">"tx5"</span><span class="p">,</span>
  <span class="s2">"tx6"</span><span class="p">,</span>
  <span class="s2">"tx7"</span><span class="p">,</span>
  <span class="s2">"tx8"</span><span class="p">,</span>
  <span class="s2">"tx9"</span><span class="p">,</span>
  <span class="s2">"tx10"</span><span class="p">,</span>
  <span class="s2">"tx11"</span><span class="p">,</span>
  <span class="p">]</span>
<span class="kd">let</span> <span class="nx">hashedtxs</span> <span class="o">=</span> <span class="p">[],</span>
  <span class="nx">branches</span> <span class="o">=</span> <span class="p">[],</span>
  <span class="nx">branchCounter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="nx">merkleRoot</span>
</code></pre></div></div> <ol> <li>The constant <code class="highlighter-rouge">sha256</code> loads the <code class="highlighter-rouge">js-sha256</code> modules via the <code class="highlighter-rouge">require()</code> function.</li> <li>The <code class="highlighter-rouge">txs[]</code> array contains a list of transactions to be summarized.</li> <li>The <code class="highlighter-rouge">hashedtxs[]</code> array contains the double-SHA256 hash of each element in <code class="highlighter-rouge">txs[]</code> array. The <code class="highlighter-rouge">hashedtxs[]</code> can also be said to contain the leaf nodes.</li> <li>The <code class="highlighter-rouge">branches[]</code> array contains a list of results obtained by concatenating and hashing two consecutive nodes.</li> <li>The <code class="highlighter-rouge">branchCounter</code> counts the number of branches calculated in order to reach the merkle root.</li> <li>The <code class="highlighter-rouge">merkleRoot</code> variable is a string representing a 32 byte alphanumeric hash. <br/></li> </ol> <h2 id="workflow">Workflow</h2> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="nx">txs</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`There are no transactions to be summarized`</span><span class="p">)</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Transactions to be summarized: </span><span class="p">${</span><span class="nx">txs</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
  <span class="nx">makeElementsEven</span><span class="p">(</span><span class="nx">txs</span><span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Leaf nodes: </span><span class="p">${</span><span class="nx">txs</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>

</code></pre></div></div> <p>We first check the <code class="highlighter-rouge">txs.length</code> to ensure that we have some transactions to summarize. If <code class="highlighter-rouge">txs.length</code> is zero, then a message is printed to the console stating that there are no transactions to be summarized.</p> <p>If there are some transactions to be summarized, we check that we have an even number of elements.</p> <ul> <li> <p>If yes, we may proceed to hashing the transactions using double-SHA256 cryptographic hashing algorithm.</p> </li> <li> <p>If there are odd number of transactions, then we duplicate the last transaction to achieve an even number of elements. This is checked by <code class="highlighter-rouge">makeElementsEven()</code> method shown below.</p> </li> </ul> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">makeElementsEven</span><span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">arr</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Cannot build Merkle Tree for odd number of data elements.`</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Duplicating the last transaction to achieve an even number of data elements.`</span><span class="p">)</span>	
    <span class="nx">arr</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">arr</span><span class="p">[</span><span class="nx">arr</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>Each element from the <code class="highlighter-rouge">txs[]</code> array is hashed using double-SHA256 cryptographic hashing algorithm and is stored in the <code class="highlighter-rouge">hashedtxs[]</code> array.</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">tx</span> <span class="k">of</span> <span class="nx">txs</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">hashedtxs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">sha256</span><span class="p">(</span><span class="nx">sha256</span><span class="p">(</span><span class="nx">tx</span><span class="p">)))</span>
  <span class="p">}</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Leaf nodes hashed using double-SHA256 algorithm:"</span><span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">hashedtxs</span><span class="p">)</span>
</code></pre></div></div> <p>For <em>n</em> number of transactions, a merkle tree needs to produce log2(<em>n</em>) 32-byte hashes, to reach the merkle root. So, we calculate that using:</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">rep</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">log2</span><span class="p">(</span><span class="nx">txs</span><span class="p">.</span><span class="nx">length</span><span class="p">))</span>
</code></pre></div></div> <p>We repeat the concatenating and hashing process of n &amp; n+1 nodes for <em><code class="highlighter-rouge">rep</code></em> number of times using a <code class="highlighter-rouge">for loop</code></p> <p>If there is only one hash in <code class="highlighter-rouge">hashedtxs[]</code> array or in <code class="highlighter-rouge">branches[]</code> array, we can say that, that element is the <code class="highlighter-rouge">merkleRoot</code>. So, we check that condition with the following code and print the merkle root to the console.</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">rep</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">hashedtxs</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">merkleRoot</span> <span class="o">=</span> <span class="nx">hashedtxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`The Merkle Root is </span><span class="p">${</span><span class="nx">merkleRoot</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">branches</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">merkleRoot</span> <span class="o">=</span> <span class="nx">branches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`The Merkle Root is </span><span class="p">${</span><span class="nx">merkleRoot</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
    <span class="p">}</span> 
</code></pre></div></div> <p>If the <code class="highlighter-rouge">hashedtxs[]</code> array contains more than one element &amp; the elements of <code class="highlighter-rouge">branches[]</code> array have not been calculated yet, i.e. <code class="highlighter-rouge">branches[]</code> array is empty, then we concatenate the n &amp; n+1 nodes from <code class="highlighter-rouge">hashedtxs[]</code> array, hash the result, and push the hash to <code class="highlighter-rouge">branches[]</code> array.</p> <p>Once the n-1 &amp; n nodes in the <code class="highlighter-rouge">hashedtxs[]</code> array have been concatenated, hashed and pushed to <code class="highlighter-rouge">branches[]</code> array, the <code class="highlighter-rouge">branchCounter</code> value is incremented. The branch along with its number and its elements is printed to the console.</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">hashedtxs</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">branches</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">hashedtxs</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">item</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">branches</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span>
            <span class="nx">sha256</span><span class="p">(</span><span class="nx">sha256</span><span class="p">(</span><span class="nx">hashedtxs</span><span class="p">[</span><span class="nx">index</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">hashedtxs</span><span class="p">[</span><span class="nx">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])))</span>
          <span class="p">)</span>
        <span class="p">}</span>
      <span class="p">})</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Branch: </span><span class="p">${(</span><span class="nx">branchCounter</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)}</span><span class="s2">`</span><span class="p">)</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">branches</span><span class="p">)</span>
</code></pre></div></div> <p>We need to check whether the calculated branch has even number of elements. If not, then make the elements even by duplicating the last element.</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      <span class="k">if</span> <span class="p">(</span><span class="nx">branches</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">branches</span><span class="p">.</span><span class="nx">length</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">makeElementsEven</span><span class="p">(</span><span class="nx">branches</span><span class="p">)</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Now, Branch </span><span class="p">${</span><span class="nx">branchCounter</span><span class="p">}</span><span class="s2"> is: `</span><span class="p">)</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">branches</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span> 
</code></pre></div></div> <p>If a branch is calculated, then we need to concatenate and hash the elements of that branch. This is done by cloning the <code class="highlighter-rouge">branches[]</code> array to a <code class="highlighter-rouge">branchesCopy[]</code> array, clear the <code class="highlighter-rouge">branches[]</code> array, and then concatenating n &amp; n+1 nodes from <code class="highlighter-rouge">branchesCopy[]</code> array, hashing them using double-SHA256 and pushing the hash to <code class="highlighter-rouge">branches[]</code> array.</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">branches</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">branchesCopy</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">branches</span><span class="p">)</span>
      <span class="nx">branches</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="nx">branchesCopy</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">item</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">branches</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span>
            <span class="nx">sha256</span><span class="p">(</span><span class="nx">sha256</span><span class="p">(</span><span class="nx">branchesCopy</span><span class="p">[</span><span class="nx">index</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">branchesCopy</span><span class="p">[</span><span class="nx">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])))</span>
          <span class="p">)</span>
        <span class="p">}</span>
      <span class="p">})</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Branch: </span><span class="p">${(</span><span class="nx">branchCounter</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)}</span><span class="s2">`</span><span class="p">)</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">branches</span><span class="p">)</span>
</code></pre></div></div> <p>Again, check whether the resulting branch has even number of elements or odd number of elements. If odd, then make it even by duplicating the last element of</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      <span class="k">if</span> <span class="p">(</span><span class="nx">branches</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">branches</span><span class="p">.</span><span class="nx">length</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">makeElementsEven</span><span class="p">(</span><span class="nx">branches</span><span class="p">)</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Now, Branch </span><span class="p">${</span><span class="nx">branchCounter</span><span class="p">}</span><span class="s2"> is: `</span><span class="p">)</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">branches</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>Repeat the process for <em>rep</em> number of times <br/></p> <h2 id="see-full-code-"><a href="./merkle-tree-full-code.html">See Full Code â€“&gt;</a></h2> <p><a href="./">back</a></p> <script type="text/javascript" src="/assets/js/jquery-3.2.1.min.js"></script> <script type="text/javascript" src="/assets/js/materialize.min.js"></script> <script src="/assets/js/init.js"></script> </body> <footer class="page-footer"> <div class="footer-copyright" style="padding-left: 30px;"> <i class="material-icons" style="padding-right:5px; display:;">copyright</i><p style="display:;">2018 Copyright | All rights reserved</p> </div> </footer> </html>